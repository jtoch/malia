<link rel="import" href="lib/bower_components/polymer/polymer.html">
<link rel="import" href="lib/bower_components/iron-ajax/iron-ajax.html">

<script src="lib/bower_components/wavesurfer.js/dist/wavesurfer.min.js"></script>


<dom-module id="sounds-listing">
  <template>
    <style>
     #waveform {
         position: sticky;
         top: 10px;
         float: right;
         height: 128px;
         outline: #f9d5ff 2px solid;
         width: 600px;
     }
     #soundList {
         border-collapse: collapse;
     }
     #soundList tr:hover td {
         background: #f9d5ff;
     }

    </style>
    <iron-ajax id="sounds" url="sounds" auto
               last-response="{{listing}}"></iron-ajax>
    <iron-ajax id="sync" url="sounds/sync" method="PUT"></iron-ajax>
    <div>
      Listing sounds on {{listing.hostname}}.
      <button on-click="resync">Resync with Firebase</button>
      {{syncStatus}}
    </div>
    <div id="waveform"></div>
    <table id="soundList">
      <template is="dom-repeat" items="{{listing.sounds}}">
        <tr on-mouseenter="loadWaveform">
          <td on-click="loadWaveform">[[item.path]]</td>
          <td>label: ...</td>
          <td><audio src="sounds/[[item.path]]" controls
                     preload="none"></audio></td>
        </tr>
      </template>
    </table>
  </template>
  <script>
   Polymer({
       is: "sounds-listing",
       ready: function() {
           this.$.sync.addEventListener('response', (ev) => {
               this.syncStatus = "done";
               this.$.sounds.generateRequest();
           });
           this.wavesurfer = WaveSurfer.create({
               container: '#waveform',
               waveColor: 'violet',
               progressColor: 'purple',
               fillParent: false,
               minPxPerSec: 60,
           });

       },
       resync: function() {
           this.$.sync.generateRequest();
           this.syncStatus = 'requested...';
       },
       loadWaveform: function(ev) {
           this.wavesurfer.load('sounds/' + ev.model.item.path);
       }
   });
  </script>
</dom-module>
