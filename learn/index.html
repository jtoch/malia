<!doctype html>
<html>
  <head>
    <title>learn</title>
    <meta charset="utf-8">
    <script src="lib/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="import" href="lib/bower_components/polymer/polymer.html">
    <link rel="import" href="lib/bower_components/iron-ajax/iron-ajax.html">
    <link rel="import" href="lib/bower_components/paper-progress/paper-progress.html">
    <link rel="import" href="lib/bower_components/chart-elements/chart-line.html">
    <style>
     h1 {
         text-align: center;
         background: #f3c162;
         padding: 4px 2px;
     }
     h2 {
         background: #f3d8a5;
         padding: 4px 2px;
     }
     details > summary > h2 { display: inline-block; }
    </style>
  </head>
  <body>

    <dom-module id="sounds-listing">
      <template>
        <iron-ajax id="sounds" url="sounds" auto last-response="{{listing}}"></iron-ajax>
        <iron-ajax id="sync" url="sounds/sync" method="PUT"></iron-ajax>
        <div>Listing sounds on {{listing.hostname}}. <button on-click="resync">Resync with Firebase</button> {{syncStatus}}</div>
        <table>
          <template is="dom-repeat" items="{{listing.sounds}}">
            <tr>
              <td>[[item.path]]</td>
              <td>label: ...</td>
              <td><audio src="sounds/[[item.path]]" controls preload="none"></audio></td>
            </tr>
          </template>
        </table>
      </template>
      <script>
       HTMLImports.whenReady(function () {
           Polymer({
               is: "sounds-listing",
               ready: function() {
                   this.$.sync.addEventListener('response', (ev) => {
                       this.syncStatus = "done";
                       this.$.sounds.generateRequest();
                   });
               },
               resync: function() {
                   this.$.sync.generateRequest();
                   this.syncStatus = 'requested...';
               }
           });
       });
      </script>
    </dom-module>

    <dom-module id="train-model">
      <template>
        <style>
          #chart { width: 80%; height: 250px; }
        </style>
        <iron-ajax id="request" method="put" url="train/restart"
                   last-response="{{log}}"
                   last-error="{{err}}"></iron-ajax>
        <div><button on-click="onRetrain">Restart training</button></div>
        <pre>[[err.request.xhr.response.exc]]</pre>
        <h3>Current status</h3>
        <div>Epoch: <paper-progress style="display: inline-block"
                                    min="0"
                                    max="[[epoch_total]]"
                                    value="[[epoch_cur]]"></paper-progress></div>
        <div>Batch: <paper-progress style="display: inline-block"
                                    min="0"
                                    max="[[batch_total]]"
                                    value="[[batch_cur]]"></paper-progress></div>
        <div>
          <chart-line id="chart"
                      data="[[chartData]]"
                      options="[[chartOptions]]"></chart-line>
        </div>
        <pre>
          <template is="dom-repeat" items="{{lines}}">
          [[item]]
          </template>
        </pre>
      </template>
      <script>
       HTMLImports.whenReady(function () {
           Polymer({
               is: "train-model",
               properties: {
                   lines: { type: Array, value: [] },
                   epoch_cur: {type: Number, notify: true},
                   epoch_total: {type: Number, notify: true},
                   batch_cur: {type: Number, notify: true},
                   batch_total: {type: Number, notify: true},
                   acc: {type: Number, notify: true},
                   loss: {type: Number, notify: true},
                   val_acc: {type: Number, notify: true},
                   val_loss: {type: Number, notify: true},
                   chartData: {type: Object},
                   chartOptions: {type: Object},
               },
               ready: function() {
                   this.resetChart();
                   this.logEvents = new EventSource('train/logs');
                   this.logEvents.addEventListener('clear', this.onLogClear.bind(this));
                   this.logEvents.addEventListener('line', this.onLogLine.bind(this));

                   this.maxLinesStored = 1000;
                   this.logEvents.addEventListener('callback', this.onLogCallback.bind(this));

               },
               resetChart: function() {
                   // http://www.chartjs.org/docs/
                   Chart.defaults.global.animation.duration = 0;
                   this.chartOptions = {
                       maintainAspectRatio: false,
                       scales: {
                           xAxes: [{
                               scaleLabel: 'epoch',
                           }]
                       }
                   };
                   this.chartData = {
                       labels: [],
                       datasets: [
                           {label: "loss", data: []},
                           {label: "acc", data: []},
                           {label: "val_loss", data: []},
                           {label: "val_acc", data: []},
                       ]
                   };
               },
               addChartEpoch: function(epoch, params) {
                   this.chartData.labels.push(epoch);
                   this.chartData.datasets[0].data.push(params.loss);
                   this.chartData.datasets[1].data.push(params.acc);
                   this.chartData.datasets[2].data.push(params.val_loss);
                   this.chartData.datasets[3].data.push(params.val_acc);
                   this.$.chart.updateChart();
               },
               onLogClear: function(ev) {
                   this.lines = [];
                   this.resetChart();
               },
               onLogLine: function(ev) {
                   this.push('lines', ev.data);
                   this.splice('lines', 0, this.lines.length - 100);
               },
               onLogCallback: function(ev) {
                   let msg = JSON.parse(ev.data);
                   if (msg.type == 'epoch_end') {
                       this.addChartEpoch(msg.params.epoch_cur - 1,msg.params);
                       // fall through to params
                   }
                   if (msg.params) {
                       for (let k in msg.params) {
                           this[k] = msg.params[k];
                       }
                       return;
                   }
                   if (msg.type == 'train_begin') {
                       this.resetChart();
                       this.lines = [];
                       return;
                   }

                   this.push('lines', ev.data);
                   this.splice('lines', 0, this.lines.length - this.maxLinesStored);
               },
               onRetrain: function(ev) {
                   this.$.request.generateRequest();
               }
           });
       });
      </script>
    </dom-module>
    
    <h1>learn</h1>
    
    <details>
      <summary><h2>Sounds</h2></summary>
      <sounds-listing></sounds-listing>
    </details>

    <details open>
      <summary><h2>Train</h2></summary>
      <train-model></train-model>
    </details>
  </body>
</html>
